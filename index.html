<div class="center" style="margin:1rem 0;">
  <button id="unlockTTS">🔓 啟動語音（iPhone 請先點我一次）</button>
</div>

<script>
  let koVoice = null;
  let speechReady = false;
  let keepAliveTimer = null;

  function loadVoices() {
    const voices = speechSynthesis.getVoices?.() || [];
    koVoice = voices.find(v => (v.lang||'').toLowerCase().startsWith('ko'))
          || voices.find(v => (v.name||'').toLowerCase().includes('korean'))
          || null;
  }
  if ('speechSynthesis' in window) {
    loadVoices();
    speechSynthesis.onvoiceschanged = loadVoices;
  }

  function ensureResume() {
    try { speechSynthesis.resume(); } catch(e) {}
  }

  // iOS：播放期間定時 "喚醒"，避免被系統暫停
  function startKeepAlive() {
    stopKeepAlive();
    keepAliveTimer = setInterval(() => {
      if (speechSynthesis.paused || !speechSynthesis.speaking) return;
      ensureResume();
    }, 900); // 0.9 秒
  }
  function stopKeepAlive() {
    if (keepAliveTimer) {
      clearInterval(keepAliveTimer);
      keepAliveTimer = null;
    }
  }

  // 解鎖（需使用者手勢）
  function unlockSpeech() {
    if (!('speechSynthesis' in window)) {
      alert('此瀏覽器不支援語音朗讀，請改用 Safari/Chrome。');
      return;
    }
    speechSynthesis.cancel();
    ensureResume();

    const u = new SpeechSynthesisUtterance('시작'); //「開始」
    u.lang = 'ko-KR';
    if (koVoice) u.voice = koVoice;
    u.volume = 0; // 靜音觸發
    u.onend = () => {
      speechReady = true;
      const btn = document.getElementById('unlockTTS');
      if (btn) {
        btn.textContent = '✅ 語音已啟動（可以播放）';
        btn.disabled = true;
        btn.style.opacity = 0.7;
      }
    };
    speechSynthesis.speak(u);
  }

  // 將長句切塊（iOS 對很長文字較不穩）
  function chunkKorean(text) {
    const t = String(text).trim();
    if (!t) return [];
    // 依句號/問號/逗號/頓號/空白做溫和切分
    const parts = t.split(/([.?!…]|[，、。？！]|\s{2,})/).filter(Boolean);
    // 合併切分符號，避免丟標點
    const merged = [];
    for (let i = 0; i < parts.length; i++) {
      const cur = parts[i];
      if (/[.?!…，、。？！]/.test(cur) && merged.length) {
        merged[merged.length - 1] += cur;
      } else if (cur.trim()) {
        merged.push(cur.trim());
      }
    }
    // 再把過短的片段合併，避免太碎
    const result = [];
    let buf = '';
    for (const seg of merged) {
      if ((buf + ' ' + seg).length <= 40) {
        buf = buf ? (buf + ' ' + seg) : seg;
      } else {
        if (buf) result.push(buf);
        buf = seg;
      }
    }
    if (buf) result.push(buf);
    return result;
  }

  // 核心播音：含 cancel/resume/失敗重試/keepAlive
  function speak(text) {
    if (!('speechSynthesis' in window)) {
      alert('此瀏覽器不支援語音朗讀。'); return;
    }
    if (!speechReady && /iPhone|iPad|iPod/i.test(navigator.userAgent)) {
      alert('請先點上方「啟動語音」一次，才能在 iPhone 播放。');
      return;
    }

    speechSynthesis.cancel();
    ensureResume();

    const queue = chunkKorean(text);
    let idx = 0;

    function playNext() {
      if (idx >= queue.length) {
        stopKeepAlive();
        return;
      }
      const u = new SpeechSynthesisUtterance(queue[idx]);
      u.lang = 'ko-KR';
      if (koVoice) u.voice = koVoice;
      u.rate = 0.95;
      u.pitch = 1.0;
      u.onstart = () => { startKeepAlive(); };
      u.onend = () => { idx++; playNext(); };
      u.onerror = () => {
        // Safari 偶發錯誤：retry 一次
        setTimeout(() => {
          ensureResume();
          speechSynthesis.cancel();
          setTimeout(() => speechSynthesis.speak(u), 120);
        }, 80);
      };
      speechSynthesis.speak(u);
    }
    playNext();
  }

  document.getElementById('unlockTTS')?.addEventListener('click', unlockSpeech);
  document.addEventListener('visibilitychange', () => {
    if (document.visibilityState === 'visible') ensureResume();
  });
  // 將 speak 暴露到全域（維持你原本按鈕 onclick="speak('...')"）
  window.speak = speak;
</script>

