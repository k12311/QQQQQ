<div class="center" style="margin:1rem 0;">
  <button id="unlockTTS">ğŸ”“ å•Ÿå‹•èªéŸ³ï¼ˆiPhone è«‹å…ˆé»æˆ‘ä¸€æ¬¡ï¼‰</button>
</div>

<script>
  let koVoice = null;
  let speechReady = false;
  let keepAliveTimer = null;

  function loadVoices() {
    const voices = speechSynthesis.getVoices?.() || [];
    koVoice = voices.find(v => (v.lang||'').toLowerCase().startsWith('ko'))
          || voices.find(v => (v.name||'').toLowerCase().includes('korean'))
          || null;
  }
  if ('speechSynthesis' in window) {
    loadVoices();
    speechSynthesis.onvoiceschanged = loadVoices;
  }

  function ensureResume() {
    try { speechSynthesis.resume(); } catch(e) {}
  }

  // iOSï¼šæ’­æ”¾æœŸé–“å®šæ™‚ "å–šé†’"ï¼Œé¿å…è¢«ç³»çµ±æš«åœ
  function startKeepAlive() {
    stopKeepAlive();
    keepAliveTimer = setInterval(() => {
      if (speechSynthesis.paused || !speechSynthesis.speaking) return;
      ensureResume();
    }, 900); // 0.9 ç§’
  }
  function stopKeepAlive() {
    if (keepAliveTimer) {
      clearInterval(keepAliveTimer);
      keepAliveTimer = null;
    }
  }

  // è§£é–ï¼ˆéœ€ä½¿ç”¨è€…æ‰‹å‹¢ï¼‰
  function unlockSpeech() {
    if (!('speechSynthesis' in window)) {
      alert('æ­¤ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³æœ—è®€ï¼Œè«‹æ”¹ç”¨ Safari/Chromeã€‚');
      return;
    }
    speechSynthesis.cancel();
    ensureResume();

    const u = new SpeechSynthesisUtterance('ì‹œì‘'); //ã€Œé–‹å§‹ã€
    u.lang = 'ko-KR';
    if (koVoice) u.voice = koVoice;
    u.volume = 0; // éœéŸ³è§¸ç™¼
    u.onend = () => {
      speechReady = true;
      const btn = document.getElementById('unlockTTS');
      if (btn) {
        btn.textContent = 'âœ… èªéŸ³å·²å•Ÿå‹•ï¼ˆå¯ä»¥æ’­æ”¾ï¼‰';
        btn.disabled = true;
        btn.style.opacity = 0.7;
      }
    };
    speechSynthesis.speak(u);
  }

  // å°‡é•·å¥åˆ‡å¡Šï¼ˆiOS å°å¾ˆé•·æ–‡å­—è¼ƒä¸ç©©ï¼‰
  function chunkKorean(text) {
    const t = String(text).trim();
    if (!t) return [];
    // ä¾å¥è™Ÿ/å•è™Ÿ/é€—è™Ÿ/é “è™Ÿ/ç©ºç™½åšæº«å’Œåˆ‡åˆ†
    const parts = t.split(/([.?!â€¦]|[ï¼Œã€ã€‚ï¼Ÿï¼]|\s{2,})/).filter(Boolean);
    // åˆä½µåˆ‡åˆ†ç¬¦è™Ÿï¼Œé¿å…ä¸Ÿæ¨™é»
    const merged = [];
    for (let i = 0; i < parts.length; i++) {
      const cur = parts[i];
      if (/[.?!â€¦ï¼Œã€ã€‚ï¼Ÿï¼]/.test(cur) && merged.length) {
        merged[merged.length - 1] += cur;
      } else if (cur.trim()) {
        merged.push(cur.trim());
      }
    }
    // å†æŠŠéçŸ­çš„ç‰‡æ®µåˆä½µï¼Œé¿å…å¤ªç¢
    const result = [];
    let buf = '';
    for (const seg of merged) {
      if ((buf + ' ' + seg).length <= 40) {
        buf = buf ? (buf + ' ' + seg) : seg;
      } else {
        if (buf) result.push(buf);
        buf = seg;
      }
    }
    if (buf) result.push(buf);
    return result;
  }

  // æ ¸å¿ƒæ’­éŸ³ï¼šå« cancel/resume/å¤±æ•—é‡è©¦/keepAlive
  function speak(text) {
    if (!('speechSynthesis' in window)) {
      alert('æ­¤ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³æœ—è®€ã€‚'); return;
    }
    if (!speechReady && /iPhone|iPad|iPod/i.test(navigator.userAgent)) {
      alert('è«‹å…ˆé»ä¸Šæ–¹ã€Œå•Ÿå‹•èªéŸ³ã€ä¸€æ¬¡ï¼Œæ‰èƒ½åœ¨ iPhone æ’­æ”¾ã€‚');
      return;
    }

    speechSynthesis.cancel();
    ensureResume();

    const queue = chunkKorean(text);
    let idx = 0;

    function playNext() {
      if (idx >= queue.length) {
        stopKeepAlive();
        return;
      }
      const u = new SpeechSynthesisUtterance(queue[idx]);
      u.lang = 'ko-KR';
      if (koVoice) u.voice = koVoice;
      u.rate = 0.95;
      u.pitch = 1.0;
      u.onstart = () => { startKeepAlive(); };
      u.onend = () => { idx++; playNext(); };
      u.onerror = () => {
        // Safari å¶ç™¼éŒ¯èª¤ï¼šretry ä¸€æ¬¡
        setTimeout(() => {
          ensureResume();
          speechSynthesis.cancel();
          setTimeout(() => speechSynthesis.speak(u), 120);
        }, 80);
      };
      speechSynthesis.speak(u);
    }
    playNext();
  }

  document.getElementById('unlockTTS')?.addEventListener('click', unlockSpeech);
  document.addEventListener('visibilitychange', () => {
    if (document.visibilityState === 'visible') ensureResume();
  });
  // å°‡ speak æš´éœ²åˆ°å…¨åŸŸï¼ˆç¶­æŒä½ åŸæœ¬æŒ‰éˆ• onclick="speak('...')"ï¼‰
  window.speak = speak;
</script>

