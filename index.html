<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>韓文朗讀測試版</title>
  <style>
    body { background: #fff0f5; font-family: Arial; padding: 2rem; text-align:center; }
    h1 { color: #d26fa0; }
    button {
      background: #ffc0cb; border: none; padding: 8px 16px;
      border-radius: 10px; margin: 8px; cursor: pointer;
    }
    button:hover { background: #ffa7bd; }
  </style>
</head>
<body>
  <h1>🔊 韓文朗讀測試版</h1>

  <div style="margin:1rem 0;">
    <button id="unlockTTS">🔓 啟動語音（iPhone 請先點我一次）</button>
  </div>

  <div>
    <button onclick="speak('저')">朗讀：저</button>
    <button onclick="speak('당신은 선생님입니까?')">朗讀：당신은 선생님입니까?</button>
    <button onclick="speak('저는 한국 사람입니다.')">朗讀：저는 한국 사람입니다.</button>
  </div>

  <script>
    let koVoice = null;
    let speechReady = false;

    function loadVoices() {
      const voices = speechSynthesis.getVoices?.() || [];
      koVoice = voices.find(v => (v.lang||'').toLowerCase().startsWith('ko'))
            || voices.find(v => (v.name||'').toLowerCase().includes('korean'))
            || null;
    }
    if ('speechSynthesis' in window) {
      loadVoices();
      speechSynthesis.onvoiceschanged = loadVoices;
    }

    function ensureResume() {
      try { speechSynthesis.resume(); } catch(e) {}
    }

    function unlockSpeech() {
      if (!('speechSynthesis' in window)) {
        alert('此瀏覽器不支援語音朗讀'); return;
      }
      speechSynthesis.cancel();
      ensureResume();
      const u = new SpeechSynthesisUtterance('시작');
      u.lang = 'ko-KR';
      if (koVoice) u.voice = koVoice;
      u.volume = 0; // 靜音觸發
      u.onend = () => {
        speechReady = true;
        const btn = document.getElementById('unlockTTS');
        if (btn) {
          btn.textContent = '✅ 語音已啟動（可以播放）';
          btn.disabled = true;
          btn.style.opacity = 0.7;
        }
      };
      speechSynthesis.speak(u);
    }

    function speak(text) {
      if (!('speechSynthesis' in window)) {
        alert('此瀏覽器不支援語音朗讀'); return;
      }
      if (!speechReady && /iPhone|iPad|iPod/i.test(navigator.userAgent)) {
        alert('請先點「啟動語音」再播放'); return;
      }
      speechSynthesis.cancel();
      ensureResume();
      const u = new SpeechSynthesisUtterance(text);
      u.lang = 'ko-KR';
      if (koVoice) u.voice = koVoice;
      u.rate = 0.95;
      u.pitch = 1.0;
      speechSynthesis.speak(u);
    }

    document.getElementById('unlockTTS')?.addEventListener('click', unlockSpeech);
    document.addEventListener('visibilitychange', () => {
      if (document.visibilityState === 'visible') ensureResume();
    });
    window.speak = speak;
  </script>
</body>
</html>

